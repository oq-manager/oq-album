<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” êµí™˜ì†Œ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    [v-cloak] { display: none !important; }
    body { background-color: #eef2f6; font-family: 'Apple SD Gothic Neo', sans-serif; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ec4899; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .btn-press:active { transform: scale(0.96); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .gauge-fill { transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-disabled { background-color: #d1d5db !important; color: #9ca3af !important; cursor: not-allowed; transform: none !important; }
    .tab-btn { font-size: 11px; font-weight: 800; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.08); }
    .tab-on { background: #111827; color: white; border-color: #111827; }
    .tab-off { background: #f3f4f6; color: #374151; }
  </style>
</head>

<body>
<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative flex flex-col overflow-hidden">

  <!-- ë¡œê·¸ì¸ -->
  <div v-if="!isLoggedIn" class="p-8 flex flex-col justify-center h-screen bg-pink-50 relative">
    <button @click="showHelpPopup = true" class="absolute top-4 right-4 text-gray-400 text-sm flex flex-col items-center">
      <i class="fas fa-question-circle text-xl mb-1"></i><span class="text-xs">ë„ì›€ë§</span>
    </button>

    <div class="text-center mb-10">
      <span class="text-4xl">ğŸ‘¸</span>
      <h1 class="text-3xl font-bold text-pink-600 mt-2">ì˜¤í”¼ìŠ¤í€¸<br>ì•¨ë²” êµí™˜ì†Œ</h1>
    </div>

    <div class="space-y-4">
      <input v-model="loginForm.server" type="number" placeholder="ì„œë²„ ë²ˆí˜¸ (ìˆ«ì)" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.nickname" type="text" placeholder="ë‹‰ë„¤ì„" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <input v-model="loginForm.password" type="password" maxlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
      <button @click="handleLogin"
              class="w-full bg-gradient-to-r from-pink-500 to-pink-400 text-white p-4 rounded-xl font-bold hover:from-pink-600 hover:to-pink-500 transition shadow-md flex justify-center items-center"
              :disabled="isLoading">
        <div v-if="isLoading" class="loader mr-2 border-white border-t-transparent"></div>
        <span>{{ isLoading ? 'ë¡œë”©ì¤‘...' : 'ì…ì¥í•˜ê¸°' }}</span>
      </button>
    </div>
    <p class="text-xs text-gray-400 text-center mt-6">ì„œë²„/ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
  </div>

  <!-- ë©”ì¸(ìœ ì €) -->
  <div v-else class="flex flex-col h-screen bg-[#f0f9ff]">

    <!-- ìƒë‹¨ -->
    <div class="sticky top-0 bg-white/90 backdrop-blur-sm z-20 border-b border-blue-100 p-3 shadow-sm flex-none">
      <div class="flex justify-between items-center mb-2">
        <div class="flex flex-col">
          <span class="font-bold text-gray-700 text-sm flex items-center">
            <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs mr-1 font-bold">S{{ userData.server }}</span>
            {{ userData.nickname }}ë‹˜
          </span>
          <span class="text-[10px] font-bold mt-1" :class="tradeCount >= 3 ? 'text-red-500' : 'text-green-600'">
            <i class="fas fa-sync-alt mr-1"></i>
            ì˜¤ëŠ˜ êµí™˜ {{ tradeCount }}/3 {{ tradeCount >= 3 ? '(ë§ˆê°)' : '' }}
          </span>
        </div>

        <div class="flex gap-2 items-center">
          <button @click="showHelpPopup = true" class="text-gray-400 hover:text-blue-500"><i class="fas fa-question-circle text-lg"></i></button>
          <button @click="openNeedsPopup" class="text-xs bg-pink-500 text-white px-2.5 py-1.5 rounded-lg font-extrabold shadow-sm hover:bg-pink-600 transition btn-press">ğŸ§¾ êµ¬í•´ìš”</button>
          <button @click="fetchUsersAndShowList" class="text-xs bg-blue-500 text-white px-2.5 py-1.5 rounded-lg font-extrabold shadow-sm hover:bg-blue-600 transition btn-press">ğŸ‘¥ ë©¤ë²„</button>
          <button @click="logout" class="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50 btn-press">ë‚˜ê°€ê¸°</button>
        </div>
      </div>

      <div class="relative w-full h-7 bg-gray-200 rounded-full shadow-inner overflow-hidden border border-gray-300">
        <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 gauge-fill" :style="{ width: totalProgress + '%' }"></div>
        <div class="absolute inset-0 flex items-center justify-center text-xs font-extrabold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.6)] z-10">
          ì „ì²´ ìˆ˜ì§‘ë¥  {{ totalCount }}/81 ({{ totalProgress }}%)
        </div>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto hide-scroll p-4 pb-20">
      <!-- ì•¨ë²” ë¦¬ìŠ¤íŠ¸ -->
      <div v-if="currentView === 'dashboard'" class="grid grid-cols-3 gap-x-2 gap-y-6">
        <div v-for="(album, idx) in appConfig.albumNames" :key="idx" @click="openAlbum(idx)" class="flex flex-col items-center cursor-pointer group">
          <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg overflow-hidden relative bg-white group-hover:scale-105 transition duration-200 ring-2 ring-gray-100">
            <img v-if="appConfig.albumCovers && appConfig.albumCovers[idx]" :src="appConfig.albumCovers[idx]" class="w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center bg-blue-50 text-3xl text-blue-200">ğŸ“</div>
            <div v-if="getAlbumCount(idx) === 9" class="absolute inset-0 bg-black/30 flex items-center justify-center">
              <i class="fas fa-check text-2xl text-green-400 drop-shadow-md"></i>
            </div>
          </div>
          <div class="mt-2 mb-1 px-2 py-0.5 rounded bg-white/50 backdrop-blur-sm">
            <span class="text-[11px] font-bold text-gray-700 text-center block truncate max-w-[80px]">{{ album }}</span>
          </div>
          <div class="w-20 h-4 bg-gray-600 rounded-full relative border border-white shadow-sm overflow-hidden">
            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full gauge-fill" :style="{ width: (getAlbumCount(idx) / 9) * 100 + '%' }"></div>
            <span class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-[0_1px_1px_rgba(0,0,0,0.5)]">{{ getAlbumCount(idx) }}/9</span>
          </div>
        </div>
      </div>

      <!-- ì•¨ë²” ìƒì„¸ -->
      <div v-if="currentView === 'detail'">
        <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-xl shadow-sm border border-blue-100">
          <button @click="prevAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600"><i class="fas fa-chevron-left"></i></button>
          <h2 class="text-sm font-bold text-gray-800">{{ appConfig.albumNames[currentAlbumIdx] }}</h2>
          <button @click="nextAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="grid grid-cols-3 gap-1.5">
          <div v-for="(count, i) in currentAlbumCards" :key="i" class="bg-white rounded-lg p-1.5 shadow-sm border border-gray-100 flex flex-col h-28 relative">
            <div class="flex-1 bg-gray-50 rounded mb-1.5 relative overflow-hidden cursor-pointer border border-gray-200 group"
                 @click="onCardTap(i)"
                 @mousedown="onCardHoldStart(i)" @mouseup="onCardHoldEnd" @mouseleave="onCardHoldEnd"
                 @touchstart.passive="onCardHoldStart(i)" @touchend="onCardHoldEnd" @touchcancel="onCardHoldEnd">
              <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                <span class="text-[9px]">ì‚¬ì§„</span><span class="text-xs font-bold">{{ i + 1 }}</span>
              </div>

              <div v-if="count === 0" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-red-500 font-bold z-10 group-hover:bg-white/70 transition">
                <i class="fas fa-search text-lg mb-1"></i><span class="text-[9px]">êµ¬í•´ìš”</span>
                <span class="text-[9px] mt-1 text-gray-400 font-extrabold">(íƒ­í•˜ë©´ ë³´ìœ ì)</span>
              </div>
            </div>

            <div class="flex items-center justify-between bg-gray-50 rounded-full p-0.5 border border-gray-200">
              <button @click="updateCount(i, -1)" class="w-5 h-5 rounded-full bg-white shadow-sm text-gray-500 flex items-center justify-center text-xs border border-gray-200 btn-press font-bold">-</button>
              <span class="flex-1 text-center text-xs font-bold" :class="count > 0 ? 'text-blue-600' : 'text-gray-300'">{{ count }}</span>
              <button @click="updateCount(i, 1)" class="w-5 h-5 rounded-full bg-blue-500 shadow-sm text-white flex items-center justify-center text-xs btn-press font-bold border-none">+</button>
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-center">
          <button @click="currentView = 'dashboard'" class="px-6 py-2 bg-gray-800 text-white text-xs rounded-full font-bold shadow-lg hover:bg-gray-700 transition flex items-center btn-press">
            <i class="fas fa-th-large mr-2"></i> ì•¨ë²” ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë©¤ë²„ íŒì—… -->
  <div v-if="showUserListPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showUserListPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[86vh] overflow-y-auto shadow-2xl hide-scroll">
      <button @click="showUserListPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>

      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-extrabold text-gray-800">ğŸ‘¥ í™œë™ ë©¤ë²„ <span class="text-blue-500">{{ filteredUserList.length }}ëª…</span></h3>
      </div>

      <div class="grid grid-cols-5 gap-2 mb-3">
        <button class="tab-btn" :class="memberFilter==='all'?'tab-on':'tab-off'" @click="memberFilter='all'">ì „ì²´</button>
        <button class="tab-btn" :class="memberFilter==='winwin'?'tab-on':'tab-off'" @click="memberFilter='winwin'">ìœˆìœˆ</button>
        <button class="tab-btn" :class="memberFilter==='receive'?'tab-on':'tab-off'" @click="memberFilter='receive'">ë°›ê¸°</button>
        <button class="tab-btn" :class="memberFilter==='give'?'tab-on':'tab-off'" @click="memberFilter='give'">ì£¼ê¸°</button>
        <button class="tab-btn" :class="memberFilter==='fav'?'tab-on':'tab-off'" @click="memberFilter='fav'">â­</button>
      </div>

      <div class="mb-3 relative">
        <input v-model="searchKeyword" type="text" placeholder="ë‹‰ë„¤ì„/ì„œë²„ ê²€ìƒ‰" class="w-full p-2.5 pl-9 border border-gray-200 rounded-xl text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-100 transition">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
      </div>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else class="space-y-2">
        <div v-for="user in filteredUserList" :key="user.id" class="border border-gray-100 p-3 rounded-xl flex justify-between items-center hover:bg-blue-50 hover:border-blue-100 transition group">
          <div class="flex items-center flex-1 cursor-pointer" @click="openCompare(user)">
            <div class="w-2 h-2 rounded-full mr-2" :class="getActiveColor(user.lastActive)"></div>
            <span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-2">S{{ user.server }}</span>
            <div class="flex flex-col flex-1 min-w-0">
              <div class="flex items-center">
                <span class="font-extrabold text-gray-700 text-sm group-hover:text-blue-600 truncate mr-1">
                  {{ user.nickname }}
                </span>
                <i v-if="user.totalCount >= 81" class="fas fa-trophy text-yellow-500 text-xs"></i>
              </div>
              <div class="flex items-center gap-2 mt-0.5">
                <span class="text-[9px] text-gray-400"><i class="fas fa-history mr-0.5"></i>{{ getActiveText(user.lastActive) }}</span>
                <span class="text-[10px] px-1.5 rounded-full" :class="user.totalCount >= 40 ? 'bg-pink-100 text-pink-600 font-extrabold' : 'bg-gray-100 text-gray-500'">{{ user.totalCount || 0 }}/81</span>
                <span v-if="user.match.winwin" class="text-[10px] bg-red-100 text-red-600 font-extrabold px-1.5 py-0.5 rounded-full">ìœˆìœˆ</span>
                <span v-else-if="user.match.receive" class="text-[10px] bg-green-100 text-green-700 font-extrabold px-1.5 py-0.5 rounded-full">ë°›ê¸°</span>
                <span v-else-if="user.match.give" class="text-[10px] bg-blue-100 text-blue-700 font-extrabold px-1.5 py-0.5 rounded-full">ì£¼ê¸°</span>
              </div>
            </div>
          </div>

          <button @click.stop="toggleFavorite(user.id)" class="w-9 h-9 rounded-xl flex items-center justify-center border border-gray-200 hover:bg-yellow-50 btn-press">
            <i class="fas fa-star" :class="isFavorite(user.id) ? 'text-yellow-400' : 'text-gray-300'"></i>
          </button>
        </div>

        <div v-if="filteredUserList.length === 0" class="text-center text-gray-400 py-8 text-xs bg-gray-50 rounded-xl">
          {{ searchKeyword ? 'ê²€ìƒ‰ëœ ë©¤ë²„ê°€ ì—†ì–´ìš”.' : 'í•„í„° ì¡°ê±´ì— ë§ëŠ” ë©¤ë²„ê°€ ì—†ì–´ìš”.' }}
        </div>
      </div>
    </div>
  </div>

  <!-- ë¹„êµ íŒì—… -->
  <div v-if="showComparePopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showComparePopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[85vh] overflow-y-auto shadow-2xl hide-scroll">
      <button @click="showComparePopup = false" class="absolute top-3 right-3 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>

      <div class="text-center mb-5 mt-2">
        <div class="text-xs text-gray-400 mb-1">ë‚˜ vs ìƒëŒ€ë°©</div>
        <h3 class="text-lg font-extrabold text-gray-800 flex justify-center items-center">
          S{{ compareTarget.server }} {{ compareTarget.nickname }}
        </h3>
      </div>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else class="space-y-3">
        <div v-if="compareResult.mutual.give.length > 0 || compareResult.mutual.receive.length > 0" class="bg-red-50 p-3 rounded-xl border border-red-100">
          <h4 class="font-extrabold text-red-500 text-xs mb-2 flex items-center"><i class="fas fa-heart mr-1"></i> ìœˆìœˆ (ì„œë¡œ í•„ìš”í•´!)</h4>

          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.mutual.give" :key="'m_g_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50">
              <span class="truncate max-w-[55%] text-gray-600">ë‚´ê°€ <span class="font-extrabold text-blue-500">ì¤Œ</span>: {{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 btn-press"><i class="far fa-copy"></i> ë³µì‚¬</button>
                <button @click="executeTrade(card, 'give')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded shadow-sm" :class="{'btn-disabled': tradeCount >= 3}" :disabled="tradeCount >= 3">ë³´ë‚´ê¸°</button>
              </div>
            </div>

            <div v-for="(card, idx) in compareResult.mutual.receive" :key="'m_r_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50">
              <span class="truncate max-w-[55%] text-gray-600">ë‚´ê°€ <span class="font-extrabold text-red-500">ë°›ìŒ</span>: {{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 btn-press"><i class="far fa-copy"></i> ë³µì‚¬</button>
                <button @click="executeTrade(card, 'receive')" class="text-[10px] bg-red-500 text-white px-2 py-1 rounded shadow-sm" :class="{'btn-disabled': tradeCount >= 3}" :disabled="tradeCount >= 3">ë°›ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="compareResult.giveOnly.length > 0" class="bg-blue-50 p-3 rounded-xl border border-blue-100">
          <h4 class="font-extrabold text-blue-500 text-xs mb-2 flex items-center"><i class="fas fa-gift mr-1"></i> ê¸°ë¶€ ê°€ëŠ¥ (ë‚˜ëŠ” ë‚¨ì•„ìš”)</h4>
          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.giveOnly" :key="'g_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-blue-50">
              <span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 btn-press"><i class="far fa-copy"></i> ë³µì‚¬</button>
                <button @click="executeTrade(card, 'give')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded shadow-sm" :class="{'btn-disabled': tradeCount >= 3}" :disabled="tradeCount >= 3">ë³´ë‚´ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="compareResult.receiveOnly.length > 0" class="bg-gray-100 p-3 rounded-xl border border-gray-200">
          <h4 class="font-extrabold text-gray-500 text-xs mb-2 flex items-center"><i class="fas fa-hand-holding mr-1"></i> êµ¬í•´ìš” (ìƒëŒ€ëŠ” ë‚¨ì•„ìš”)</h4>
          <div class="space-y-1.5">
            <div v-for="(card, idx) in compareResult.receiveOnly" :key="'r_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-gray-100">
              <span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span>
              <div class="flex gap-1">
                <button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 btn-press"><i class="far fa-copy"></i> ë³µì‚¬</button>
                <button @click="executeTrade(card, 'receive')" class="text-[10px] bg-green-500 text-white px-2 py-1 rounded shadow-sm" :class="{'btn-disabled': tradeCount >= 3}" :disabled="tradeCount >= 3">ë°›ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="compareResult.giveOnly.length === 0 && compareResult.receiveOnly.length === 0 && compareResult.mutual.give.length === 0 && compareResult.mutual.receive.length === 0"
             class="text-center text-gray-400 text-xs py-8 bg-gray-50 rounded-xl">
          êµí™˜í•  ìˆ˜ ìˆëŠ” ì¹´ë“œê°€ ì—†ì–´ìš” ğŸ˜…
        </div>
      </div>
    </div>
  </div>

  <!-- ë³´ìœ ì ì°¾ê¸° íŒì—… -->
  <div v-if="showPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
      <button @click="showPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>
      <h3 class="text-lg font-extrabold mb-1 text-gray-800">ğŸ¤ êµí™˜ ë„ìš°ë¯¸</h3>
      <p class="text-xs text-gray-500 mb-6 border-b pb-2"><span class="text-pink-600 font-extrabold">{{ popupCardName }}</span> ë³´ìœ ì ì°¾ê¸°</p>

      <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>

      <div v-else-if="exchangeList.length === 0" class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl">
        <div class="text-2xl mb-2">ğŸ˜­</div>ì—¬ìœ ë¶„ ìˆëŠ” ì¹œêµ¬ê°€ ì—†ì–´ìš”
      </div>

      <div v-else class="space-y-3 max-h-[55vh] overflow-y-auto pr-1 hide-scroll">
        <div v-for="user in exchangeList" :key="user.id" class="border border-gray-100 p-3 rounded-xl bg-white shadow-sm flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <div class="font-extrabold text-gray-700 text-sm">
              <span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-1">S{{ user.server }}</span>{{ user.nickname }}
            </div>
            <button @click="openCompare(user)" class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded shadow-sm btn-press">ì „ì²´ ë¹„êµ</button>
          </div>
          <div v-if="user.giveable.length > 0" class="bg-blue-50 p-2 rounded-lg">
            <div class="text-[10px] text-blue-500 font-extrabold mb-1 flex items-center"><i class="fas fa-gift mr-1"></i> ë‚´ê°€ ì¤„ ìˆ˜ ìˆëŠ” ê²ƒ(ìƒëŒ€ê°€ í•„ìš”):</div>
            <div class="flex flex-wrap gap-1">
              <span v-for="(card, cIdx) in user.giveable" :key="cIdx" class="text-[9px] bg-white border border-blue-100 px-1.5 py-0.5 rounded text-gray-500">{{ card }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- êµ¬í•´ìš” ëª©ë¡ -->
  <div v-if="showNeedsPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showNeedsPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[85vh] overflow-y-auto shadow-2xl hide-scroll">
      <button @click="showNeedsPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>

      <div class="mb-4">
        <h3 class="text-lg font-extrabold text-gray-800">ğŸ§¾ êµ¬í•´ìš” ëª©ë¡</h3>
        <p class="text-xs text-gray-500 mt-1">0ì¸ ì¹´ë“œë§Œ ë³´ì—¬ìš”. (ì—¬ìœ ë¶„ ë³´ìœ ì ìˆ˜ í‘œì‹œ)</p>
      </div>

      <div class="mb-3 relative">
        <input v-model="needsKeyword" type="text" placeholder="ì•¨ë²”ëª…/ì‚¬ì§„ë²ˆí˜¸ ê²€ìƒ‰" class="w-full p-2.5 pl-9 border border-gray-200 rounded-xl text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-pink-100 transition">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
      </div>

      <div v-if="needsLoading" class="flex justify-center py-10"><div class="loader"></div></div>

      <div v-else-if="needsListFiltered.length===0" class="text-center text-gray-400 py-10 bg-gray-50 rounded-xl">
        ğŸ‰ êµ¬í•´ìš”ê°€ ì—†ì–´ìš”!
      </div>

      <div v-else class="space-y-2">
        <button v-for="item in needsListFiltered" :key="item.index"
                @click="openExchangeByAbsoluteIndex(item.index)"
                class="w-full text-left border border-gray-100 p-3 rounded-xl hover:bg-pink-50 hover:border-pink-100 transition btn-press">
          <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold text-gray-800 text-sm truncate">{{ item.name }}</div>
            <span class="text-[10px] px-2 py-1 rounded-full font-extrabold"
                  :class="item.owners>0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'">
              ë³´ìœ ì {{ item.owners }}ëª…
            </span>
          </div>
          <div class="text-[11px] text-gray-500 mt-1">íƒ­í•˜ë©´ ë³´ìœ ì ì°¾ê¸°</div>
        </button>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ -->
  <div v-if="showHelpPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showHelpPopup = false">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
      <button @click="showHelpPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times text-xl"></i></button>

      <h3 class="text-lg font-extrabold text-gray-800 mb-4 text-center">ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</h3>

      <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-6 text-center">
        <span class="text-red-600 font-extrabold text-xs block mb-1">âš ï¸ ì£¼ì˜ì‚¬í•­ (í•„ë…)</span>
        <p class="text-xs text-red-500 leading-tight">
          ì´ ì•±ì€ <b class="underline">ì¥ë¶€</b>ì¼ ë¿ì…ë‹ˆë‹¤!<br>
          ê±°ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ ê²Œì„ ì•„ì´í…œì€ ì´ë™í•˜ì§€ ì•Šì•„ìš”.<br>
          <span class="font-bold">ë°˜ë“œì‹œ ê²Œì„ì—ì„œ ë¨¼ì € êµí™˜í•˜ê³ </span> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </p>
      </div>

      <div class="space-y-4 mb-6">
        <div class="flex gap-3">
          <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-extrabold text-xs flex-none">1</div>
          <div>
            <h4 class="text-sm font-extrabold text-gray-700">ì¹´ë“œ ì…ë ¥</h4>
            <p class="text-xs text-gray-500 leading-snug">ì•¨ë²”ì—ì„œ + - ë¡œ ìˆ˜ëŸ‰ ì…ë ¥ (ìë™ ì €ì¥)</p>
          </div>
        </div>
        <div class="flex gap-3">
          <div class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-extrabold text-xs flex-none">2</div>
          <div>
            <h4 class="text-sm font-extrabold text-gray-700">1:1 ë§êµí™˜</h4>
            <p class="text-xs text-gray-500 leading-snug">ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë¹„êµ > ëˆ„ë¥´ë©´ êµí™˜ ì¹´ë“œê°€ ë‚˜ì˜µë‹ˆë‹¤.</p>
          </div>
        </div>
        <div class="flex gap-3">
          <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center font-extrabold text-xs flex-none">3</div>
          <div>
            <h4 class="text-sm font-extrabold text-gray-700">ë³µì‚¬ & ë¶™ì—¬ë„£ê¸°</h4>
            <p class="text-xs text-gray-500 leading-snug">ë³µì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!</p>
          </div>
        </div>
      </div>

      <p class="text-center text-xs text-pink-500 mb-4">ğŸš« ì˜¤ë¥˜ ì œë³´ ë° ë¬¸ì˜: <b>67ì„­ ì‹œì†Œ</b></p>

      <button @click="showHelpPopup = false" class="w-full bg-gray-800 text-white py-3 rounded-xl font-extrabold text-sm hover:bg-gray-700 btn-press">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
    </div>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCFV593GWa2VoOf4IqMhVmbW2BGQqkDsE4",
    authDomain: "office-queen-album.firebaseapp.com",
    projectId: "office-queen-album",
    storageBucket: "office-queen-album.firebasestorage.app",
    messagingSenderId: "936201723618",
    appId: "1:936201723618:web:e4ec53040d668f023988bb",
    measurementId: "G-CEENHZG8HZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const { createApp, ref, computed } = Vue;

  createApp({
    setup() {
      const isLoggedIn = ref(false);
      const isLoading = ref(false);

      const currentView = ref('dashboard');
      const loginForm = ref({ server: '', nickname: '', password: '' });

      const userData = ref(null);
      const currentAlbumIdx = ref(0);
      const tradeCount = ref(0);

      // popups
      const showPopup = ref(false);
      const showUserListPopup = ref(false);
      const showComparePopup = ref(false);
      const showHelpPopup = ref(false);
      const showNeedsPopup = ref(false);

      // needs
      const needsKeyword = ref('');
      const needsLoading = ref(false);
      const spareOwnerCounts = ref(Array(81).fill(0));

      // lists
      const exchangeList = ref([]);
      const userList = ref([]);
      const compareTarget = ref({});
      const compareResult = ref({ mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] });

      // search/filter
      const searchKeyword = ref('');
      const memberFilter = ref('all');

      const appConfig = ref({
        albumNames: Array(9).fill().map((_, i) => `ì•¨ë²” ${i+1}`),
        albumCovers: Array(9).fill("")
      });

      const safeNick = (v) => (v || '').toString().trim();
      const safeServer = (v) => Number(v || 0);

      const getGameDate = () => {
        const now = new Date();
        if (now.getHours() < 8) now.setDate(now.getDate() - 1);
        return now.toISOString().split('T')[0];
      };

      const tsToDate = (timestamp) => {
        if (!timestamp) return null;
        if (timestamp.toDate && typeof timestamp.toDate === 'function') return timestamp.toDate();
        if (timestamp instanceof Date) return timestamp;
        if (typeof timestamp === 'number') return new Date(timestamp);
        return null;
      };

      const getActiveText = (timestamp) => {
        const date = tsToDate(timestamp);
        if (!date) return 'ë¯¸ì ‘ì†';
        try {
          const diff = Date.now() - date.getTime();
          const min = 60 * 1000; const hour = 60 * min; const day = 24 * hour;
          if (diff < 10 * min) return 'ë°©ê¸ˆ ì „';
          if (diff < hour) return `${Math.floor(diff / min)}ë¶„ ì „`;
          if (diff < day) return `${Math.floor(diff / hour)}ì‹œê°„ ì „`;
          return `${Math.floor(diff / day)}ì¼ ì „`;
        } catch(e) { return 'ë¯¸ì ‘ì†'; }
      };

      const getActiveColor = (timestamp) => {
        const date = tsToDate(timestamp);
        if (!date) return 'bg-gray-300';
        try {
          const diff = Date.now() - date.getTime();
          if (diff < 60 * 60 * 1000) return 'bg-green-500';
          if (diff < 24 * 60 * 60 * 1000) return 'bg-yellow-400';
          return 'bg-gray-300';
        } catch(e) { return 'bg-gray-300'; }
      };

      const cardNameByIndex = (absIdx) => {
        const aIdx = Math.floor(absIdx/9);
        const cIdx = (absIdx%9)+1;
        const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`;
        return `${albumName} - ì‚¬ì§„${cIdx}`;
      };

      // favorites (ìœ ì €ë³„ localStorage)
      const favKey = computed(() => {
        if (!userData.value) return 'oq_fav_guest';
        return `oq_fav_S${userData.value.server}_${userData.value.nickname}`;
      });
      const loadFavSet = () => {
        try {
          const raw = localStorage.getItem(favKey.value);
          const arr = raw ? JSON.parse(raw) : [];
          return new Set(Array.isArray(arr) ? arr : []);
        } catch(e) { return new Set(); }
      };
      const favSet = ref(new Set());
      const isFavorite = (id) => favSet.value.has(id);
      const toggleFavorite = (id) => {
        if (!id) return;
        const s = new Set(favSet.value);
        if (s.has(id)) s.delete(id); else s.add(id);
        favSet.value = s;
        localStorage.setItem(favKey.value, JSON.stringify(Array.from(s)));
      };

      const checkAndResetDailyLimit = async () => {
        if (!userData.value) return;
        const today = getGameDate();
        if (userData.value.dailyExchangeDate !== today) {
          userData.value.dailyExchangeCount = 0;
          userData.value.dailyExchangeDate = today;
          tradeCount.value = 0;
          const docId = `S${userData.value.server}_${userData.value.nickname}`;
          try { await db.collection('users').doc(docId).update({ dailyExchangeCount: 0, dailyExchangeDate: today }); } catch(e) {}
        } else {
          tradeCount.value = userData.value.dailyExchangeCount || 0;
        }
      };

      const updateLastActive = async () => {
        if (!userData.value) return;
        const docId = `S${userData.value.server}_${userData.value.nickname}`;
        try { await db.collection('users').doc(docId).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e) {}
      };

      const loadAppConfig = async () => {
        try {
          const doc = await db.collection('config').doc('service_info').get();
          if (doc.exists) {
            const data = doc.data();
            if (Array.isArray(data.albumNames)) appConfig.value.albumNames = data.albumNames;
            if (Array.isArray(data.albumCovers)) appConfig.value.albumCovers = data.albumCovers;
          }
        } catch (e) {}
      };

      const refreshSpareOwnerCounts = async () => {
        if (!userData.value) return;
        needsLoading.value = true;
        try {
          const counts = Array(81).fill(0);
          const snap = await db.collection('users').get();
          snap.forEach(doc => {
            const u = doc.data();
            if (!u) return;

            // í˜¹ì‹œ ê³¼ê±° admin ë¬¸ì„œê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆì–´ ì•ˆì „ ì²˜ë¦¬
            if (u.role === 'admin') return;

            if (u.server === userData.value.server && u.nickname === userData.value.nickname) return;

            const col = Array.isArray(u.collection) ? u.collection : [];
            for (let i=0; i<81; i++) {
              if ((col[i] || 0) > 1) counts[i] += 1;
            }
          });
          spareOwnerCounts.value = counts;
        } catch(e) {
          spareOwnerCounts.value = Array(81).fill(0);
        } finally {
          needsLoading.value = false;
        }
      };

      const buildCompare = (targetUser) => {
        compareTarget.value = targetUser || {};
        const myCol = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);
        const targetCol = (targetUser && Array.isArray(targetUser.collection)) ? targetUser.collection : Array(81).fill(0);

        const res = { mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] };

        for (let i=0; i<81; i++) {
          const cardObj = { index: i, name: cardNameByIndex(i) };
          const iHaveSpare = myCol[i] > 1;
          const iNeed = myCol[i] === 0;
          const uHaveSpare = targetCol[i] > 1;
          const uNeed = targetCol[i] === 0;

          if (iHaveSpare && uNeed) res.giveOnly.push(cardObj);
          if (uHaveSpare && iNeed) res.receiveOnly.push(cardObj);
        }

        if (res.giveOnly.length > 0 && res.receiveOnly.length > 0) {
          res.mutual.give = [...res.giveOnly];
          res.mutual.receive = [...res.receiveOnly];
        }
        compareResult.value = res;
      };

      const openCompare = (targetUser) => {
        showUserListPopup.value = false;
        showPopup.value = false;
        if (!targetUser || !targetUser.id) return;
        buildCompare(targetUser);
        showComparePopup.value = true;
      };

      const top3GiveableToTarget = (targetUser) => {
        const myCol = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);
        const targetCol = (targetUser && Array.isArray(targetUser.collection)) ? targetUser.collection : Array(81).fill(0);
        const list = [];
        for (let i=0; i<81; i++) {
          if (myCol[i] > 1 && targetCol[i] === 0) list.push(cardNameByIndex(i));
          if (list.length >= 3) break;
        }
        return list;
      };

      const copyTradeText = (card, type) => {
        const myServer = userData.value.server;
        const myName = userData.value.nickname;
        const targetServer = compareTarget.value.server;
        const targetName = compareTarget.value.nickname;

        const suggest = top3GiveableToTarget(compareTarget.value);
        const suggestText = suggest.length ? `\n(ì œê°€ ì¤„ ìˆ˜ ìˆëŠ” ì¹´ë“œ: ${suggest.join(', ')})` : '';

        let text = (type === 'give')
          ? `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\n[${card.name}] ë“œë¦´ê²Œìš”! êµí™˜í•˜ì‹¤ë˜ìš”?${suggestText}`
          : `[ì˜¤í”¼ìŠ¤í€¸] S${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\ní˜¹ì‹œ [${card.name}] êµí™˜í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?${suggestText}`;

        navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”."));
      };

      const executeTrade = async (card, type) => {
        await checkAndResetDailyLimit();
        if (tradeCount.value >= 3) {
          alert("ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ 3íšŒë¥¼ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ì˜¤ì „ 8ì‹œì— ë‹¤ì‹œ ê°€ëŠ¥í•´ìš”! ğŸŒ™");
          return;
        }
        const actionName = type === 'give' ? `[${card.name}] ì„(ë¥¼) ì£¼ì‹œê² ìŠµë‹ˆê¹Œ?` : `[${card.name}] ì„(ë¥¼) ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`;
        const effect = type === 'give' ? "ë‚´ ìˆ˜ëŸ‰ -1 / ìƒëŒ€ ìˆ˜ëŸ‰ +1" : "ë‚´ ìˆ˜ëŸ‰ +1 / ìƒëŒ€ ìˆ˜ëŸ‰ -1";
        if (!confirm(`${actionName}\n(${effect})\n\në‚˜ì™€ ìƒëŒ€ë°©ì˜ êµí™˜ íšŸìˆ˜ê°€ 1íšŒì”© ì°¨ê°ë©ë‹ˆë‹¤.`)) return;

        isLoading.value = true;
        try {
          const myDocId = `S${userData.value.server}_${userData.value.nickname}`;
          const myDocRef = db.collection('users').doc(myDocId);
          const targetDocRef = db.collection('users').doc(compareTarget.value.id);
          const today = getGameDate();

          await db.runTransaction(async (tx) => {
            const myDoc = await tx.get(myDocRef);
            const targetDoc = await tx.get(targetDocRef);
            if (!myDoc.exists || !targetDoc.exists) throw "ë¬¸ì„œ ì—†ìŒ";

            const myData = myDoc.data();
            const targetData = targetDoc.data();

            let myCurrentCount = myData.dailyExchangeCount || 0;
            if (myData.dailyExchangeDate !== today) myCurrentCount = 0;
            if (myCurrentCount >= 3) throw "ì˜¤ëŠ˜ ë‚˜ì˜ êµí™˜ í•œë„ê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!";

            let targetCount = targetData.dailyExchangeCount || 0;
            if (targetData.dailyExchangeDate !== today) targetCount = 0;
            if (targetCount >= 3) throw `ìƒëŒ€ë°©(${targetData.nickname}ë‹˜)ì˜ ì˜¤ëŠ˜ êµí™˜ íšŸìˆ˜ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`;

            const myCol = Array.isArray(myData.collection) ? myData.collection : Array(81).fill(0);
            const targetCol = Array.isArray(targetData.collection) ? targetData.collection : Array(81).fill(0);
            const idx = card.index;

            if (type === 'give') {
              if (myCol[idx] < 1) throw "ì˜¤ë¥˜: ë‚´ ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!";
              myCol[idx]--; targetCol[idx]++;
            } else {
              if (targetCol[idx] < 1) throw "ì˜¤ë¥˜: ìƒëŒ€ë°© ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!";
              myCol[idx]++; targetCol[idx]--;
            }

            const now = firebase.firestore.FieldValue.serverTimestamp();
            tx.update(myDocRef, { collection: myCol, dailyExchangeCount: myCurrentCount + 1, dailyExchangeDate: today, lastUpdated: now, lastActive: now });
            tx.update(targetDocRef, { collection: targetCol, dailyExchangeCount: targetCount + 1, dailyExchangeDate: today, lastUpdated: now });

            userData.value.collection = myCol;
            userData.value.dailyExchangeCount = myCurrentCount + 1;
            userData.value.dailyExchangeDate = today;
            tradeCount.value = myCurrentCount + 1;
            compareTarget.value.collection = targetCol;
          });

          localStorage.setItem('oq_user_v4', JSON.stringify(userData.value));
          alert(`ê±°ë˜ ì™„ë£Œ! (ì˜¤ëŠ˜ ${tradeCount.value}/3íšŒ ì™„ë£Œ)`);
          buildCompare(compareTarget.value);
        } catch (e) {
          alert("ê±°ë˜ ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const needsList = computed(() => {
        const col = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);
        const arr = [];
        for (let i=0; i<81; i++) {
          if (col[i] === 0) {
            arr.push({ index: i, name: cardNameByIndex(i), owners: spareOwnerCounts.value[i] || 0 });
          }
        }
        return arr;
      });

      const needsListFiltered = computed(() => {
        const kw = (needsKeyword.value || '').trim().toLowerCase();
        if (!kw) return needsList.value;
        return needsList.value.filter(x => x.name.toLowerCase().includes(kw));
      });

      const openNeedsPopup = async () => {
        needsKeyword.value = '';
        showNeedsPopup.value = true;
        await refreshSpareOwnerCounts();
      };

      const exchangeAbsIndex = ref(null);
      const popupCardName = computed(() => {
        const abs = exchangeAbsIndex.value;
        if (abs === null || abs === undefined) return '';
        return cardNameByIndex(abs);
      });

      const openExchangeByAbsoluteIndex = async (absIdx) => {
        showNeedsPopup.value = false;
        showPopup.value = true;
        exchangeList.value = [];
        isLoading.value = true;
        exchangeAbsIndex.value = absIdx;

        try {
          const snap = await db.collection('users').get();
          const matches = [];
          const myCol = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);

          snap.forEach(doc => {
            const u = doc.data();
            if (!u || u.role === 'admin') return;
            if (u.server === userData.value.server && u.nickname === userData.value.nickname) return;

            if (Array.isArray(u.collection) && (u.collection[absIdx] || 0) > 1) {
              const giveable = [];
              for (let k=0; k<81; k++) {
                if ((myCol[k] || 0) > 1 && (u.collection[k] || 0) === 0) giveable.push(cardNameByIndex(k));
              }
              matches.push({ id: doc.id, server: u.server, nickname: u.nickname, collection: u.collection, lastActive: u.lastActive, giveable });
            }
          });

          matches.sort((a,b) => (tsToDate(b.lastActive)?.getTime()||0) - (tsToDate(a.lastActive)?.getTime()||0));
          exchangeList.value = matches;
        } catch (e) {
          alert("ë³´ìœ ì ì°¾ê¸° ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const updateCount = (i, chg) => {
        if (!userData.value) return;
        if (!Array.isArray(userData.value.collection)) userData.value.collection = Array(81).fill(0);

        const abs = (currentAlbumIdx.value * 9) + i;
        const next = (userData.value.collection[abs] || 0) + chg;
        if (next < 0) return;

        userData.value.collection[abs] = next;
        localStorage.setItem('oq_user_v4', JSON.stringify(userData.value));

        const docId = `S${userData.value.server}_${userData.value.nickname}`;
        db.collection('users').doc(docId).update({ collection: userData.value.collection, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
        updateLastActive();
      };

      const onCardTapCore = (albumLocalIdx) => {
        const absIdx = (currentAlbumIdx.value * 9) + albumLocalIdx;
        const col = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);
        if (col[absIdx] === 0) openExchangeByAbsoluteIndex(absIdx);
        else updateCount(albumLocalIdx, 1);
      };

      let holdTimer = null;
      let holdTriggered = false;

      const onCardHoldStart = (i) => {
        holdTriggered = false;
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = setTimeout(() => {
          holdTriggered = true;
          updateCount(i, -1);
        }, 450);
      };

      const onCardHoldEnd = () => {
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = null;
      };

      const onCardTap = (i) => {
        if (holdTriggered) { holdTriggered = false; return; }
        onCardTapCore(i);
      };

      const getAlbumCount = (idx) => userData.value ? userData.value.collection.slice(idx*9, idx*9+9).filter(c=>c>0).length : 0;
      const totalCount = computed(() => userData.value ? userData.value.collection.filter(c=>c>0).length : 0);
      const totalProgress = computed(() => Math.round((totalCount.value/81)*100));
      const currentAlbumCards = computed(() => userData.value ? userData.value.collection.slice(currentAlbumIdx.value*9, (currentAlbumIdx.value*9)+9) : []);
      const openAlbum = (idx) => { currentAlbumIdx.value = idx; currentView.value = 'detail'; };
      const prevAlbum = () => { if(currentAlbumIdx.value > 0) currentAlbumIdx.value--; };
      const nextAlbum = () => { if(currentAlbumIdx.value < 8) currentAlbumIdx.value++; };

      const computeMatchFlags = (target) => {
        const myCol = (userData.value && Array.isArray(userData.value.collection)) ? userData.value.collection : Array(81).fill(0);
        const targetCol = (target && Array.isArray(target.collection)) ? target.collection : Array(81).fill(0);
        let give = false, receive = false;
        for (let i=0; i<81; i++) {
          if (!give && myCol[i] > 1 && targetCol[i] === 0) give = true;
          if (!receive && targetCol[i] > 1 && myCol[i] === 0) receive = true;
          if (give && receive) break;
        }
        return { give, receive, winwin: give && receive };
      };

      const filteredUserList = computed(() => {
        let list = Array.isArray(userList.value) ? [...userList.value] : [];
        const kw = (searchKeyword.value || '').toLowerCase().trim();
        if (kw) list = list.filter(u => (u.nickname || '').toLowerCase().includes(kw) || String(u.server || '').includes(kw));

        if (memberFilter.value === 'fav') list = list.filter(u => isFavorite(u.id));
        else if (memberFilter.value === 'winwin') list = list.filter(u => u.match && u.match.winwin);
        else if (memberFilter.value === 'receive') list = list.filter(u => u.match && u.match.receive);
        else if (memberFilter.value === 'give') list = list.filter(u => u.match && u.match.give);

        list.sort((a,b) => {
          const fa = isFavorite(a.id) ? 1 : 0;
          const fb = isFavorite(b.id) ? 1 : 0;
          if (fb !== fa) return fb - fa;
          return (tsToDate(b.lastActive)?.getTime()||0) - (tsToDate(a.lastActive)?.getTime()||0);
        });
        return list;
      });

      const fetchUsersAndShowList = async () => {
        showUserListPopup.value = true;
        isLoading.value = true;
        searchKeyword.value = '';
        memberFilter.value = 'all';
        userList.value = [];

        try {
          const snapshot = await db.collection('users').get();
          const users = [];
          snapshot.forEach(doc => {
            const u = doc.data();
            if (!u || u.role === 'admin') return;
            if (u.server === userData.value.server && u.nickname === userData.value.nickname) return;

            const total = (u.collection || []).reduce((a, b) => a + (b>0?1:0), 0);
            if (total <= 0) return;

            users.push({
              id: doc.id,
              server: u.server,
              nickname: u.nickname,
              collection: u.collection,
              lastActive: u.lastActive,
              totalCount: total,
              match: computeMatchFlags(u)
            });
          });
          userList.value = users;
        } catch(e) {
          alert("ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: " + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const handleLogin = async () => {
        if (isLoading.value) return;

        let server = loginForm.value.server;
        let nickname = safeNick(loginForm.value.nickname);
        let password = (loginForm.value.password || '').trim();

        if (!nickname || !password) { alert('ì •ë³´ ì…ë ¥!'); return; }
        if (!/^\d{4}$/.test(password)) { alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬!'); return; }
        if (/\s/.test(nickname)) { alert("ë‹‰ë„¤ì„ì— ê³µë°±ì€ ì•ˆë¼ìš”!"); return; }

        server = safeServer(server);
        if (!server) { alert('ì„œë²„ ì…ë ¥!'); return; }

        const docId = `S${server}_${nickname}`;
        await processLogin(docId, { nickname, server, password, role: 'user' });
      };

      const processLogin = async (docId, userInfo) => {
        isLoading.value = true;
        await loadAppConfig();

        try {
          const docRef = db.collection('users').doc(docId);
          const doc = await docRef.get();

          let finalData;
          if (doc.exists) {
            const data = doc.data();
            if ((data.password || '') !== userInfo.password) { alert('ë¹„ë²ˆ í‹€ë¦¼'); return; }
            if (!Array.isArray(data.collection) || data.collection.length !== 81) data.collection = Array(81).fill(0);
            // í˜¹ì‹œ ì´ì „ì— admin roleì´ ì„ì—¬ìˆì–´ë„ ìœ ì €ë¡œ ê³ ì •
            data.role = 'user';
            finalData = data;
          } else {
            finalData = {
              ...userInfo,
              collection: Array(81).fill(0),
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastActive: firebase.firestore.FieldValue.serverTimestamp(),
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
              dailyExchangeCount: 0,
              dailyExchangeDate: getGameDate()
            };
            await docRef.set(finalData);
          }

          userData.value = finalData;
          localStorage.setItem('oq_user_v4', JSON.stringify(finalData));
          favSet.value = loadFavSet();

          isLoggedIn.value = true;
          await checkAndResetDailyLimit();
          updateLastActive();
        } catch(e) {
          alert('ì˜¤ë¥˜: ' + (e.message || e));
        } finally {
          isLoading.value = false;
        }
      };

      const checkLogin = async () => {
        const saved = localStorage.getItem('oq_user_v4');
        if (!saved) return;
        try {
          userData.value = JSON.parse(saved);
          await loadAppConfig();
          favSet.value = loadFavSet();
          isLoggedIn.value = true;

          await checkAndResetDailyLimit();
          updateLastActive();
        } catch(e) {}
      };
      checkLogin();

      const logout = () => {
        localStorage.removeItem('oq_user_v4');
        userData.value = null;
        isLoggedIn.value = false;
        loginForm.value = { server: '', nickname: '', password: '' };
        currentView.value = 'dashboard';
        showPopup.value = false;
        showUserListPopup.value = false;
        showComparePopup.value = false;
        showNeedsPopup.value = false;
      };

      return {
        isLoggedIn, isLoading, loginForm, handleLogin, logout,
        userData,
        currentView, currentAlbumIdx, currentAlbumCards,
        openAlbum, prevAlbum, nextAlbum,
        updateCount, onCardTap, onCardHoldStart, onCardHoldEnd,
        getAlbumCount, totalCount, totalProgress,
        tradeCount,
        showPopup, showUserListPopup, showComparePopup, showHelpPopup,
        showNeedsPopup, openNeedsPopup, needsKeyword, needsListFiltered, needsLoading,
        openExchangeByAbsoluteIndex, exchangeList, popupCardName,
        fetchUsersAndShowList, userList, filteredUserList, searchKeyword, memberFilter,
        toggleFavorite, isFavorite,
        openCompare, compareTarget, compareResult,
        copyTradeText, executeTrade,
        getActiveText, getActiveColor,
        appConfig
      };
    }
  }).mount('#app');
</script>
</body>
</html>
