<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #eef2f6; font-family: 'Apple SD Gothic Neo', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ec4899; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-press:active { transform: scale(0.95); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .gauge-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>

    <div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative flex flex-col overflow-hidden">
        
        <div v-if="!isLoggedIn" class="p-8 flex flex-col justify-center h-screen bg-pink-50 relative">
            <button @click="showHelpPopup = true" class="absolute top-4 right-4 text-gray-400 text-sm flex flex-col items-center">
                <i class="fas fa-question-circle text-xl mb-1"></i><span class="text-xs">ë„ì›€ë§</span>
            </button>
            
            <div class="text-center mb-10">
                <span class="text-4xl">ğŸ‘¸</span>
                <h1 class="text-3xl font-bold text-pink-600 mt-2">ì˜¤í”¼ìŠ¤í€¸<br>ì•¨ë²” êµí™˜ì†Œ</h1>
            </div>
            
            <div class="space-y-4">
                <input v-model="loginForm.server" type="number" placeholder="ì„œë²„ ë²ˆí˜¸ (ìˆ«ì)" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                <input v-model="loginForm.nickname" type="text" placeholder="ë‹‰ë„¤ì„ (ê´€ë¦¬ìëŠ” 'ê´€ë¦¬ì')" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                <input v-model="loginForm.password" type="password" maxlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" class="w-full p-4 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                
                <button @click="handleLogin" class="w-full bg-gradient-to-r from-pink-500 to-pink-400 text-white p-4 rounded-xl font-bold hover:from-pink-600 hover:to-pink-500 transition shadow-md flex justify-center items-center" :disabled="isLoading">
                    <div v-if="isLoading" class="loader mr-2 border-white border-t-transparent"></div>
                    <span>{{ isLoading ? 'ë¡œë”©ì¤‘...' : 'ì…ì¥í•˜ê¸°' }}</span>
                </button>
            </div>
            <p class="text-xs text-gray-400 text-center mt-6">ì„œë²„/ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ìë™ ê°€ì…ë©ë‹ˆë‹¤.</p>
        </div>

        <div v-else class="flex flex-col h-screen bg-[#f0f9ff]">
            
            <div class="sticky top-0 bg-white/90 backdrop-blur-sm z-20 border-b border-blue-100 p-3 shadow-sm flex-none">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-gray-700 text-sm flex items-center">
                        <span v-if="isAdmin" class="text-red-500 mr-1 text-lg">ğŸ‘‘</span>
                        <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs mr-1 font-bold">S{{ userData.server }}</span>
                        {{ userData.nickname }}ë‹˜
                    </span>
                    <div class="flex gap-2 items-center">
                        <button @click="showHelpPopup = true" class="text-gray-400 hover:text-blue-500"><i class="fas fa-question-circle text-lg"></i></button>
                        <button @click="fetchUsersAndShowList" class="text-xs bg-blue-500 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm hover:bg-blue-600 transition">ğŸ‘¥ ë©¤ë²„</button>
                        <button v-if="isAdmin" @click="showAdminPopup = true" class="text-xs bg-gray-700 text-white px-2 py-1.5 rounded-lg shadow-sm">âš™ï¸</button>
                        <button @click="logout" class="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">ë‚˜ê°€ê¸°</button>
                    </div>
                </div>
                <div class="relative w-full h-7 bg-gray-200 rounded-full shadow-inner overflow-hidden border border-gray-300">
                    <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 gauge-fill" :style="{ width: totalProgress + '%' }"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-extrabold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.6)] z-10">
                        ì „ì²´ ìˆ˜ì§‘ë¥  {{ totalCount }}/81 ({{ totalProgress }}%)
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto hide-scroll p-4 pb-20">
                
                <div v-if="currentView === 'dashboard'" class="grid grid-cols-3 gap-x-2 gap-y-6">
                    <div v-for="(album, idx) in appConfig.albumNames" :key="idx" @click="openAlbum(idx)" class="flex flex-col items-center cursor-pointer group">
                        <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg overflow-hidden relative bg-white group-hover:scale-105 transition duration-200 ring-2 ring-gray-100">
                            <img v-if="appConfig.albumCovers && appConfig.albumCovers[idx]" :src="appConfig.albumCovers[idx]" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center bg-blue-50 text-3xl text-blue-200">ğŸ“</div>
                            <div v-if="getAlbumCount(idx) === 9" class="absolute inset-0 bg-black/30 flex items-center justify-center"><i class="fas fa-check text-2xl text-green-400 drop-shadow-md"></i></div>
                        </div>
                        <div class="mt-2 mb-1 px-2 py-0.5 rounded bg-white/50 backdrop-blur-sm"><span class="text-[11px] font-bold text-gray-700 text-center block truncate max-w-[80px]">{{ album }}</span></div>
                        <div class="w-20 h-4 bg-gray-600 rounded-full relative border border-white shadow-sm overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full gauge-fill" :style="{ width: (getAlbumCount(idx) / 9) * 100 + '%' }"></div>
                            <span class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-[0_1px_1px_rgba(0,0,0,0.5)]">{{ getAlbumCount(idx) }}/9</span>
                        </div>
                    </div>
                </div>

                <div v-if="currentView === 'detail'">
                    <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-xl shadow-sm border border-blue-100">
                        <button @click="prevAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600"><i class="fas fa-chevron-left"></i></button>
                        <h2 class="text-sm font-bold text-gray-800">{{ appConfig.albumNames[currentAlbumIdx] }}</h2>
                        <button @click="nextAlbum" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 btn-press text-gray-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div v-for="(count, i) in currentAlbumCards" :key="i" class="bg-white rounded-lg p-1.5 shadow-sm border border-gray-100 flex flex-col h-28 relative">
                            <div class="flex-1 bg-gray-50 rounded mb-1.5 relative overflow-hidden cursor-pointer border border-gray-200 group" @click="checkExchange(i)">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300"><span class="text-[9px]">ì‚¬ì§„</span><span class="text-xs font-bold">{{ i + 1 }}</span></div>
                                <div v-if="count === 0" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-red-500 font-bold z-10 group-hover:bg-white/70 transition"><i class="fas fa-search text-lg mb-1"></i><span class="text-[9px]">êµ¬í•´ìš”</span></div>
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 rounded-full p-0.5 border border-gray-200">
                                <button @click="updateCount(i, -1)" class="w-5 h-5 rounded-full bg-white shadow-sm text-gray-500 flex items-center justify-center text-xs border border-gray-200 btn-press font-bold">-</button>
                                <span class="flex-1 text-center text-xs font-bold" :class="count > 0 ? 'text-blue-600' : 'text-gray-300'">{{ count }}</span>
                                <button @click="updateCount(i, 1)" class="w-5 h-5 rounded-full bg-blue-500 shadow-sm text-white flex items-center justify-center text-xs btn-press font-bold border-none">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center"><button @click="currentView = 'dashboard'" class="px-6 py-2 bg-gray-800 text-white text-xs rounded-full font-bold shadow-lg hover:bg-gray-700 transition flex items-center"><i class="fas fa-th-large mr-2"></i> ì•¨ë²” ëª©ë¡ìœ¼ë¡œ</button></div>
                </div>
            </div>
        </div>

        <div v-if="showUserListPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showUserListPopup = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[80vh] overflow-y-auto shadow-2xl">
                <button @click="showUserListPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>
                <h3 class="text-base font-bold mb-4 text-gray-800">ğŸ‘¥ í™œë™ ë©¤ë²„ <span class="text-blue-500">{{ filteredUserList.length }}ëª…</span></h3>
                <div class="mb-3 relative">
                    <input v-model="searchKeyword" type="text" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰" class="w-full p-2.5 pl-9 border border-gray-200 rounded-xl text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-100 transition">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                </div>
                <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>
                <div v-else class="space-y-2">
                    <div v-for="user in filteredUserList" :key="user.id" @click="openCompare(user)" class="border border-gray-100 p-3 rounded-xl flex justify-between items-center hover:bg-blue-50 hover:border-blue-100 cursor-pointer transition group">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full mr-2" :class="getActiveColor(user.lastActive)"></div>
                            <span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-2">S{{ user.server }}</span>
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-700 text-sm group-hover:text-blue-600">{{ user.nickname }}</span>
                                <span class="text-[9px] text-gray-400">{{ getActiveText(user.lastActive) }}</span>
                            </div>
                        </div>
                        <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 group-hover:bg-blue-200 group-hover:text-blue-700 transition">ë¹„êµ ></span>
                    </div>
                    <div v-if="filteredUserList.length === 0" class="text-center text-gray-400 py-8 text-xs bg-gray-50 rounded-xl">{{ searchKeyword ? 'ê²€ìƒ‰ëœ ë©¤ë²„ê°€ ì—†ì–´ìš”.' : 'í™œë™ ì¤‘ì¸ ë©¤ë²„ê°€ ì—†ì–´ìš”.' }}</div>
                </div>
            </div>
        </div>

        <div v-if="showComparePopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showComparePopup = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5 relative max-h-[85vh] overflow-y-auto shadow-2xl">
                <button @click="showComparePopup = false" class="absolute top-3 right-3 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>
                <div class="text-center mb-5 mt-2">
                    <div class="text-xs text-gray-400 mb-1">ë‚˜ vs ìƒëŒ€ë°©</div>
                    <h3 class="text-lg font-bold text-gray-800 flex justify-center items-center">S{{ compareTarget.server }} {{ compareTarget.nickname }}</h3>
                </div>
                <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>
                <div v-else class="space-y-3">
                    <div v-if="compareResult.mutual.give.length > 0 || compareResult.mutual.receive.length > 0" class="bg-red-50 p-3 rounded-xl border border-red-100">
                        <h4 class="font-bold text-red-500 text-xs mb-2 flex items-center"><i class="fas fa-heart mr-1"></i> ìœˆìœˆ (ì„œë¡œ í•„ìš”í•´!)</h4>
                        <div class="space-y-1.5">
                            <div v-for="(card, idx) in compareResult.mutual.give" :key="'m_g_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50"><span class="truncate max-w-[55%] text-gray-600">ë‚´ê°€ <span class="font-bold text-blue-500">ì¤Œ</span>: {{ card.name }}</span><div class="flex gap-1"><button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"><i class="far fa-copy"></i> ë³µì‚¬</button><button @click="executeTrade(card, 'give')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded btn-press">ë³´ë‚´ê¸°</button></div></div>
                            <div v-for="(card, idx) in compareResult.mutual.receive" :key="'m_r_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-red-50"><span class="truncate max-w-[55%] text-gray-600">ë‚´ê°€ <span class="font-bold text-red-500">ë°›ìŒ</span>: {{ card.name }}</span><div class="flex gap-1"><button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"><i class="far fa-copy"></i> ë³µì‚¬</button><button @click="executeTrade(card, 'receive')" class="text-[10px] bg-red-500 text-white px-2 py-1 rounded btn-press">ë°›ê¸°</button></div></div>
                        </div>
                    </div>
                    <div v-if="compareResult.giveOnly.length > 0" class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <h4 class="font-bold text-blue-500 text-xs mb-2 flex items-center"><i class="fas fa-gift mr-1"></i> ê¸°ë¶€ ê°€ëŠ¥ (ë‚˜ëŠ” ë‚¨ì•„ìš”)</h4>
                        <div class="space-y-1.5"><div v-for="(card, idx) in compareResult.giveOnly" :key="'g_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-blue-50"><span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span><div class="flex gap-1"><button @click="copyTradeText(card, 'give')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"><i class="far fa-copy"></i> ë³µì‚¬</button><button @click="executeTrade(card, 'give')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded btn-press">ë³´ë‚´ê¸°</button></div></div></div>
                    </div>
                    <div v-if="compareResult.receiveOnly.length > 0" class="bg-gray-100 p-3 rounded-xl border border-gray-200">
                        <h4 class="font-bold text-gray-500 text-xs mb-2 flex items-center"><i class="fas fa-hand-holding mr-1"></i> êµ¬í•´ìš” (ìƒëŒ€ëŠ” ë‚¨ì•„ìš”)</h4>
                        <div class="space-y-1.5"><div v-for="(card, idx) in compareResult.receiveOnly" :key="'r_'+idx" class="flex justify-between items-center bg-white p-2 rounded-lg text-xs shadow-sm border border-gray-100"><span class="text-gray-600 truncate max-w-[55%]">{{ card.name }}</span><div class="flex gap-1"><button @click="copyTradeText(card, 'receive')" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"><i class="far fa-copy"></i> ë³µì‚¬</button><button @click="executeTrade(card, 'receive')" class="text-[10px] bg-green-500 text-white px-2 py-1 rounded btn-press">ë°›ê¸°</button></div></div></div>
                    </div>
                    <div v-if="compareResult.giveOnly.length === 0 && compareResult.receiveOnly.length === 0 && compareResult.mutual.give.length === 0" class="text-center text-gray-400 text-xs py-8 bg-gray-50 rounded-xl">êµí™˜í•  ìˆ˜ ìˆëŠ” ì¹´ë“œê°€ ì—†ì–´ìš” ğŸ˜…</div>
                </div>
            </div>
        </div>

        <div v-if="showPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showPopup = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
                <button @click="showPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>
                <h3 class="text-lg font-bold mb-1 text-gray-800">ğŸ¤ êµí™˜ ë„ìš°ë¯¸</h3>
                <p class="text-xs text-gray-500 mb-6 border-b pb-2"><span class="text-pink-600 font-bold">{{ appConfig.albumNames[currentAlbumIdx] }} - ì‚¬ì§„{{ targetCardIdx + 1 }}</span> ë³´ìœ ì ì°¾ê¸°</p>
                <div v-if="isLoading" class="flex justify-center py-8"><div class="loader"></div></div>
                <div v-else-if="exchangeList.length === 0" class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl"><div class="text-2xl mb-2">ğŸ˜­</div>ì—¬ìœ ë¶„ ìˆëŠ” ì¹œêµ¬ê°€ ì—†ì–´ìš”</div>
                <div v-else class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
                    <div v-for="user in exchangeList" :key="user.id" class="border border-gray-100 p-3 rounded-xl bg-white shadow-sm flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <div class="font-bold text-gray-700 text-sm"><span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-1">S{{ user.server }}</span>{{ user.nickname }}</div>
                            <button @click="openCompare(user)" class="text-[10px] bg-gray-800 text-white px-2 py-1 rounded shadow-sm">ì „ì²´ ë¹„êµ</button>
                        </div>
                        <div v-if="user.giveable.length > 0" class="bg-blue-50 p-2 rounded-lg"><div class="text-[10px] text-blue-500 font-bold mb-1 flex items-center"><i class="fas fa-gift mr-1"></i> ë‚˜ë„ ì¤„ ìˆ˜ ìˆëŠ” ê²ƒ:</div><div class="flex flex-wrap gap-1"><span v-for="(card, cIdx) in user.giveable" :key="cIdx" class="text-[9px] bg-white border border-blue-100 px-1.5 py-0.5 rounded text-gray-500">{{ card }}</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showHelpPopup" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showHelpPopup = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl">
                <button @click="showHelpPopup = false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times text-xl"></i></button>
                <h3 class="text-lg font-bold text-gray-800 mb-6 text-center">ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</h3>
                <div class="space-y-4 text-sm text-gray-600">
                    <div class="flex items-start"><div class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">1</div><div><span class="font-bold text-gray-800 block mb-0.5">ì¹´ë“œ ì…ë ¥</span>ì•¨ë²”ì—ì„œ <code>+</code> <code>-</code> ë¡œ ìˆ˜ëŸ‰ ì…ë ¥ (ìë™ ì €ì¥)</div></div>
                    <div class="flex items-start"><div class="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">2</div><div><span class="font-bold text-gray-800 block mb-0.5">1:1 ë§êµí™˜</span>ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ <code>ë¹„êµ ></code>ë¥¼ ëˆ„ë¥´ë©´ ì„œë¡œ ìœˆìœˆì¸ ì¹´ë“œê°€ ë‚˜ì˜µë‹ˆë‹¤.</div></div>
                    <div class="flex items-start"><div class="bg-gray-100 text-gray-600 w-6 h-6 rounded-full flex items-center justify-center font-bold mr-3 flex-shrink-0">3</div><div><span class="font-bold text-gray-800 block mb-0.5">ë³µì‚¬ & ë¶™ì—¬ë„£ê¸°</span><code>ë³µì‚¬</code> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!</div></div>
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-400">ğŸš« ì˜¤ë¥˜ ì œë³´ ë° ë¬¸ì˜: <span class="font-bold text-pink-500">67ì„­ ì‹œì†Œ</span></p>
                </div>

                <button @click="showHelpPopup = false" class="w-full bg-gray-800 text-white py-3 rounded-xl mt-4 font-bold text-sm hover:bg-gray-700">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
            </div>
        </div>

        <div v-if="showAdminPopup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-gray-800">ğŸ›  ì„¤ì •</h2><button @click="showAdminPopup = false" class="text-gray-500"><i class="fas fa-times text-xl"></i></button></div>
                <div class="space-y-6 mb-8">
                    <div v-for="(name, idx) in appConfig.albumNames" :key="idx" class="border-b pb-4"><label class="block text-sm font-bold text-gray-700 mb-2">ì•¨ë²” {{ idx + 1 }}</label><div class="grid grid-cols-1 gap-2"><input v-model="appConfig.albumNames[idx]" type="text" class="w-full p-2 border rounded text-sm"><input v-model="appConfig.albumCovers[idx]" type="text" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ" class="w-full p-2 border rounded text-sm text-gray-500"></div></div>
                </div>
                <div class="flex justify-end gap-2 mb-8"><button @click="saveAppConfig" class="px-6 py-3 bg-blue-600 text-white rounded font-bold w-full">ì €ì¥</button></div>
                <div class="border-t-2 border-red-100 pt-6 mt-6 bg-red-50 p-4 rounded-lg"><button @click="resetAllUsers" class="w-full bg-red-500 text-white py-3 rounded font-bold">ğŸ§¨ ì‹œì¦Œ ì´ˆê¸°í™”</button></div>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyCFV593GWa2VoOf4IqMhVmbW2BGQqkDsE4",
            authDomain: "office-queen-album.firebaseapp.com",
            projectId: "office-queen-album",
            storageBucket: "office-queen-album.firebasestorage.app",
            messagingSenderId: "936201723618",
            appId: "1:936201723618:web:e4ec53040d668f023988bb",
            measurementId: "G-CEENHZG8HZ"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const ADMIN_PASSWORD = "1299"; 

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const isLoggedIn = ref(false);
                const isLoading = ref(false);
                const currentView = ref('dashboard');
                const loginForm = ref({ server: '', nickname: '', password: '' });
                const userData = ref(null);
                const currentAlbumIdx = ref(0);
                
                const showPopup = ref(false);
                const showUserListPopup = ref(false);
                const showComparePopup = ref(false);
                const showAdminPopup = ref(false);
                const showHelpPopup = ref(false);
                
                const targetCardIdx = ref(0);
                const exchangeList = ref([]);
                const userList = ref([]);
                const compareTarget = ref(null);
                const compareResult = ref({ mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] });
                const searchKeyword = ref('');

                const appConfig = ref({
                    albumNames: Array(9).fill().map((_, i) => `ì•¨ë²” ${i+1}`),
                    albumCovers: Array(9).fill("")
                });

                const isAdmin = computed(() => userData.value && userData.value.role === 'admin');
                const filteredUserList = computed(() => {
                    if (!userList.value.length) return [];
                    let list = userList.value;
                    if (searchKeyword.value) {
                        const keyword = searchKeyword.value.toLowerCase();
                        list = list.filter(user => user.nickname.toLowerCase().includes(keyword) || String(user.server).includes(keyword));
                    }
                    list.sort((a, b) => {
                        const timeA = a.lastActive ? a.lastActive.toMillis() : 0;
                        const timeB = b.lastActive ? b.lastActive.toMillis() : 0;
                        return timeB - timeA;
                    });
                    return list;
                });

                const getActiveText = (timestamp) => {
                    if (!timestamp) return 'ë¯¸ì ‘ì†';
                    try {
                        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                        const diff = Date.now() - date.getTime();
                        const min = 60 * 1000;
                        const hour = 60 * min;
                        const day = 24 * hour;
                        if (diff < 10 * min) return 'ë°©ê¸ˆ ì „';
                        if (diff < hour) return `${Math.floor(diff / min)}ë¶„ ì „`;
                        if (diff < day) return `${Math.floor(diff / hour)}ì‹œê°„ ì „`;
                        return `${Math.floor(diff / day)}ì¼ ì „`;
                    } catch(e) { return 'ë¯¸ì ‘ì†'; }
                };

                const getActiveColor = (timestamp) => {
                    if (!timestamp) return 'bg-gray-300';
                    try {
                        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                        const diff = Date.now() - date.getTime();
                        if (diff < 30 * 60 * 1000) return 'bg-green-500';
                        if (diff < 24 * 60 * 60 * 1000) return 'bg-yellow-400';
                        return 'bg-gray-300';
                    } catch(e) { return 'bg-gray-300'; }
                };

                const copyTradeText = (card, type) => {
                    const myServer = userData.value.server;
                    const myName = userData.value.nickname;
                    const targetServer = compareTarget.value.server;
                    const targetName = compareTarget.value.nickname;
                    let text = "";
                    if (type === 'give') {
                        text = `[ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” êµí™˜]\nS${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\nì œê°€ [${card.name}] ë“œë¦´ ìˆ˜ ìˆì–´ìš”! êµí™˜í•˜ì‹¤ë˜ìš”?`;
                    } else {
                        text = `[ì˜¤í”¼ìŠ¤í€¸ ì•¨ë²” êµí™˜]\nS${targetServer} ${targetName}ë‹˜! S${myServer} ${myName}ì…ë‹ˆë‹¤.\ní˜¹ì‹œ [${card.name}] ì €í•œí…Œ êµí™˜í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?`;
                    }
                    navigator.clipboard.writeText(text).then(() => { alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nê²Œì„ ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”."); });
                };

                const updateLastActive = async () => {
                    if (!userData.value || isAdmin.value) return;
                    const docId = `S${userData.value.server}_${userData.value.nickname}`;
                    await db.collection('users').doc(docId).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                };

                const loadAppConfig = async () => {
                    try {
                        const doc = await db.collection('config').doc('service_info').get();
                        if (doc.exists) {
                            const data = doc.data();
                            if(data.albumNames) appConfig.value.albumNames = data.albumNames;
                            if(data.albumCovers) appConfig.value.albumCovers = data.albumCovers;
                        }
                    } catch (e) {}
                };

                const fetchUsersAndShowList = async () => {
                    showUserListPopup.value = true;
                    isLoading.value = true;
                    searchKeyword.value = '';
                    userList.value = [];
                    try {
                        const snapshot = await db.collection('users').get();
                        const users = [];
                        snapshot.forEach(doc => {
                            const u = doc.data();
                            if (u.nickname !== userData.value.nickname && u.role !== 'admin') {
                                const total = u.collection ? u.collection.reduce((a, b) => a + b, 0) : 0;
                                if (total > 0) users.push({ id: doc.id, ...u });
                            }
                        });
                        userList.value = users;
                    } catch (e) { alert("ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨"); } 
                    finally { isLoading.value = false; }
                };

                const openCompare = (targetUser) => {
                    showUserListPopup.value = false;
                    showPopup.value = false;
                    compareTarget.value = targetUser;
                    
                    const myCol = userData.value.collection || Array(81).fill(0);
                    const targetCol = targetUser.collection || Array(81).fill(0);
                    const res = { mutual: { give: [], receive: [] }, giveOnly: [], receiveOnly: [] };

                    for(let i=0; i<81; i++) {
                        const aIdx = Math.floor(i/9);
                        const cIdx = (i%9)+1;
                        const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`;
                        const cardName = `${albumName} - ì‚¬ì§„${cIdx}`;
                        const cardObj = { index: i, name: cardName };

                        const iHaveSpare = myCol[i] > 1;
                        const iNeed = myCol[i] === 0;
                        const uHaveSpare = targetCol[i] > 1;
                        const uNeed = targetCol[i] === 0;

                        if (iHaveSpare && uNeed) res.giveOnly.push(cardObj);
                        if (uHaveSpare && iNeed) res.receiveOnly.push(cardObj);
                    }
                    if (res.giveOnly.length > 0 && res.receiveOnly.length > 0) {
                        res.mutual.give = [...res.giveOnly];
                        res.mutual.receive = [...res.receiveOnly];
                    }
                    compareResult.value = res;
                    showComparePopup.value = true;
                };

                const executeTrade = async (card, type) => {
                    const actionName = type === 'give' ? `[${card.name}] ì„(ë¥¼) ì£¼ì‹œê² ìŠµë‹ˆê¹Œ?` : `[${card.name}] ì„(ë¥¼) ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    const effect = type === 'give' ? "ë‚´ ìˆ˜ëŸ‰ -1 / ìƒëŒ€ ìˆ˜ëŸ‰ +1" : "ë‚´ ìˆ˜ëŸ‰ +1 / ìƒëŒ€ ìˆ˜ëŸ‰ -1";
                    if (!confirm(`${actionName}\n(${effect})\n\nìƒëŒ€ë°© ë°ì´í„°ë„ ìë™ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤!`)) return;

                    isLoading.value = true;
                    try {
                        const myDocRef = db.collection('users').doc(isAdmin.value ? 'MASTER_ADMIN' : `S${userData.value.server}_${userData.value.nickname}`);
                        const targetDocRef = db.collection('users').doc(compareTarget.value.id);

                        await db.runTransaction(async (transaction) => {
                            const myDoc = await transaction.get(myDocRef);
                            const targetDoc = await transaction.get(targetDocRef);
                            if (!myDoc.exists || !targetDoc.exists) throw "ë¬¸ì„œ ì—†ìŒ";

                            const myCol = myDoc.data().collection;
                            const targetCol = targetDoc.data().collection;
                            const idx = card.index;

                            if (type === 'give') {
                                if (myCol[idx] < 1) throw "ì˜¤ë¥˜: ë‚´ ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!";
                                myCol[idx]--; targetCol[idx]++;
                            } else {
                                if (targetCol[idx] < 1) throw "ì˜¤ë¥˜: ìƒëŒ€ë°© ì¹´ë“œê°€ ë¶€ì¡±í•´ìš”!";
                                myCol[idx]++; targetCol[idx]--;
                            }
                            transaction.update(myDocRef, { collection: myCol });
                            transaction.update(targetDocRef, { collection: targetCol });
                            userData.value.collection = myCol;
                            compareTarget.value.collection = targetCol;
                        });
                        localStorage.setItem(isAdmin.value ? 'oq_user_admin' : 'oq_user_v4', JSON.stringify(userData.value));
                        updateLastActive();
                        alert("ê±°ë˜ ì™„ë£Œ!");
                        openCompare(compareTarget.value); 
                    } catch (e) { alert("ê±°ë˜ ì‹¤íŒ¨: " + e); } 
                    finally { isLoading.value = false; }
                };
                
                const saveAppConfig = async () => { if (!confirm("ì €ì¥í• ê¹Œìš”?")) return; try { await db.collection('config').doc('service_info').set(appConfig.value); alert("ì €ì¥ë¨"); showAdminPopup.value = false; } catch (e) { alert("ì‹¤íŒ¨"); } };
                const resetAllUsers = async () => { if (!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; isLoading.value = true; try { const snap = await db.collection('users').get(); const updates = []; snap.forEach(doc => updates.push(doc.ref.update({ collection: Array(81).fill(0) }))); await Promise.all(updates); if(userData.value) { userData.value.collection = Array(81).fill(0); localStorage.setItem('oq_user_v4', JSON.stringify(userData.value)); } alert("ì™„ë£Œ"); showAdminPopup.value = false; } catch (e) {} finally { isLoading.value = false; } };
                const handleLogin = async () => { if (isLoading.value) return; const { server, nickname, password } = loginForm.value; if (!nickname || !password) { alert('ì •ë³´ ì…ë ¥!'); return; } if (nickname === 'ê´€ë¦¬ì') { if (password !== ADMIN_PASSWORD) { alert("ë¹„ë²ˆ í‹€ë¦¼"); return; } await processLogin('MASTER_ADMIN', { nickname: 'ê´€ë¦¬ì', server: 0, password: ADMIN_PASSWORD, role: 'admin' }); return; } if (!server) { alert('ì„œë²„ ì…ë ¥!'); return; } await processLogin(`S${server}_${nickname}`, { nickname, server, password, role: 'user' }); };
                const processLogin = async (docId, userInfo) => { isLoading.value = true; await loadAppConfig(); const docRef = db.collection('users').doc(docId); try { const doc = await docRef.get(); let finalData; if (doc.exists) { const data = doc.data(); if (data.password !== userInfo.password) { alert('ë¹„ë²ˆ í‹€ë¦¼'); isLoading.value = false; return; } if (Array.isArray(data.collection) && Array.isArray(data.collection[0])) data.collection = Array(81).fill(0); finalData = data; } else { finalData = { ...userInfo, collection: Array(81).fill(0), createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastActive: firebase.firestore.FieldValue.serverTimestamp() }; await docRef.set(finalData); } userData.value = finalData; localStorage.setItem('oq_user_v4', JSON.stringify(finalData)); updateLastActive(); isLoggedIn.value = true; } catch (e) { alert('ì˜¤ë¥˜: ' + e.message); } finally { isLoading.value = false; } };
                const checkLogin = async () => { const savedUser = localStorage.getItem('oq_user_v4'); if (savedUser) { try { userData.value = JSON.parse(savedUser); await loadAppConfig(); isLoggedIn.value = true; updateLastActive(); } catch(e) {} } }; checkLogin();
                const logout = () => { localStorage.removeItem('oq_user_v4'); userData.value = null; isLoggedIn.value = false; loginForm.value = { server: '', nickname: '', password: '' }; };
                const currentAlbumCards = computed(() => userData.value ? userData.value.collection.slice(currentAlbumIdx.value*9, (currentAlbumIdx.value*9)+9) : []);
                const updateCount = (i, chg) => { if (!userData.value) return; const rIdx = (currentAlbumIdx.value*9)+i; if (userData.value.collection[rIdx]+chg < 0) return; userData.value.collection[rIdx] += chg; localStorage.setItem('oq_user_v4', JSON.stringify(userData.value)); const docId = userData.value.role === 'admin' ? 'MASTER_ADMIN' : `S${userData.value.server}_${userData.value.nickname}`; db.collection('users').doc(docId).update({collection: userData.value.collection}).catch(()=>{}); updateLastActive(); };
                const getAlbumCount = (idx) => userData.value ? userData.value.collection.slice(idx*9, idx*9+9).filter(c=>c>0).length : 0;
                const totalCount = computed(() => userData.value ? userData.value.collection.filter(c=>c>0).length : 0);
                const totalProgress = computed(() => Math.round((totalCount.value/81)*100));
                const openAlbum = (idx) => { currentAlbumIdx.value = idx; currentView.value = 'detail'; };
                const prevAlbum = () => { if(currentAlbumIdx.value > 0) currentAlbumIdx.value--; };
                const nextAlbum = () => { if(currentAlbumIdx.value < 8) currentAlbumIdx.value++; };
                
                const checkExchange = async (i) => { const rIdx = (currentAlbumIdx.value*9)+i; if (userData.value.collection[rIdx]>0) return; targetCardIdx.value = i; showPopup.value = true; exchangeList.value = []; isLoading.value = true; try { const snap = await db.collection('users').get(); const matches = []; snap.forEach(doc => { const u = doc.data(); if(u.nickname === userData.value.nickname) return; if(u.collection && u.collection[rIdx] > 1) { const giveable = []; for(let k=0; k<81; k++) { if(userData.value.collection[k]>1 && u.collection[k]===0) { const aIdx = Math.floor(k/9); const albumName = appConfig.value.albumNames[aIdx] || `ì•¨ë²”${aIdx+1}`; giveable.push(`${albumName} - ì‚¬ì§„${(k%9)+1}`); } } matches.push({id:doc.id, server:u.server, nickname:u.nickname, collection: u.collection, giveable}); } }); exchangeList.value = matches; } catch(e){} finally { isLoading.value = false; } };

                return { 
                    isLoggedIn, isLoading, loginForm, handleLogin, logout, userData, isAdmin,
                    currentView, currentAlbumIdx, currentAlbumCards, appConfig,
                    openAlbum, prevAlbum, nextAlbum, updateCount, getAlbumCount, totalCount, totalProgress, 
                    checkExchange, showPopup, showAdminPopup, showUserListPopup, showComparePopup, showHelpPopup,
                    targetCardIdx, exchangeList, userList, compareTarget, compareResult,
                    saveAppConfig, resetAllUsers, fetchUsersAndShowList, openCompare, executeTrade, copyTradeText,
                    searchKeyword, filteredUserList, getActiveText, getActiveColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>